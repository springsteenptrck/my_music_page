{% extends "base.html" %}

{% block title %}Music - Patrick James Springsteen{% endblock %}

{% block content %}
<h2>Welcome to My Music World</h2>

<div class="slider-container">
    <div class="slider">
        <div class="video-container" data-video-id="lLZegKJHp4k">
            <div id="player1"></div>
        </div>
        <div class="video-container" data-video-id="UEF4wF5l39w">
            <div id="player2"></div>
        </div>
        <div class="video-container" data-video-id="lEUnblr2KZQ">
            <div id="player3"></div>
        </div>
        <div class="video-container" data-video-id="UxoWF60Ub38">
            <div id="player4"></div>
        </div>
        <div class="video-container" data-video-id="xeFUtjC8P_E">
            <div id="player5"></div>
        </div>
    </div>
    <button class="slider-button prev">&lt;</button>
    <button class="slider-button next">&gt;</button>
</div>

<iframe allowtransparency="true" scrolling="no" frameborder="no" src="https://w.soundcloud.com/icon/?url=http%3A%2F%2Fsoundcloud.com%2Fpatrick-springsteen&color=white_orange&size=32" style="width: 32px; height: 32px;">
</iframe>

<div class="playlist-container">
    <h3>My Playlist</h3>
    <iframe width="100%" height="450" scrolling="no" frameborder="no" allow="autoplay" src="https://w.soundcloud.com/player/?url=https%3A//api.soundcloud.com/playlists/1881597659&color=%236e11ae&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true"></iframe>
    <div style="font-size: 10px; color: #cccccc;line-break: anywhere;word-break: normal;overflow: hidden;white-space: nowrap;text-overflow: ellipsis; font-family: Interstate,Lucida Grande,Lucida Sans Unicode,Lucida Sans,Garuda,Verdana,Tahoma,sans-serif;font-weight: 100;">
        <a href="https://soundcloud.com/patrick-springsteen" title="Patrick James Springsteen" target="_blank" style="color: #cccccc; text-decoration: none;">Patrick James Springsteen</a> Â·
        <a href="https://soundcloud.com/patrick-springsteen/sets/mix-1" title="Mix 1" target="_blank" style="color: #cccccc; text-decoration: none;">Mix 1</a>
    </div>
</div>

<script>
// Load YouTube IFrame API
var tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

let videoContainers;
let activePlayer = null;
let interactiveBackground = null;
let audioContext;
let analyzer;
let audioIsInitialized = false;

function onYouTubeIframeAPIReady() {
  videoContainers = document.querySelectorAll('.video-container');

  videoContainers.forEach(function(container, index) {
    var videoId = container.getAttribute('data-video-id');
    var playerId = 'player' + (index + 1);
    if (videoId && document.getElementById(playerId)) {
      new YT.Player(playerId, {
        height: '315',
        width: '560',
        videoId: videoId,
        events: {
          'onStateChange': onPlayerStateChange
        }
      });
    }
  });

  initializeInteractiveBackground();
}

function initializeAudio() {
  if (!audioIsInitialized) {
    try {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      analyzer = audioContext.createAnalyser();
      analyzer.fftSize = 256;
      audioIsInitialized = true;
      console.log('Audio initialized successfully');
    } catch (error) {
      console.error('Failed to initialize audio:', error);
    }
  }
}

function onPlayerStateChange(event) {
  switch(event.data) {
    case YT.PlayerState.PLAYING:
      if (activePlayer && activePlayer !== event.target) {
        activePlayer.pauseVideo();
      }
      activePlayer = event.target;
      if (!audioIsInitialized) {
        initializeAudio();
      }
      window.dispatchEvent(new CustomEvent('videoStateChange', {
        detail: {
          state: 'playing'
        }
      }));
      break;
    case YT.PlayerState.PAUSED:
    case YT.PlayerState.ENDED:
    case YT.PlayerState.BUFFERING:
      if (activePlayer === event.target) {
        window.dispatchEvent(new CustomEvent('videoStateChange', {
          detail: {
            state: event.data === YT.PlayerState.BUFFERING ? 'buffering' : 'paused'
          }
        }));
      }
      break;
  }
}

function initializeInteractiveBackground() {
  if (typeof YouTubeInteractiveBackground === 'function' && !interactiveBackground) {
    interactiveBackground = new YouTubeInteractiveBackground('backgroundCanvas');
  } else if (!YouTubeInteractiveBackground) {
    console.log('YouTubeInteractiveBackground not found, retrying in 1 second');
    setTimeout(initializeInteractiveBackground, 1000);
  }
}

document.addEventListener('DOMContentLoaded', function() {
  if (typeof YT !== 'undefined' && typeof YT.Player !== 'undefined') {
    onYouTubeIframeAPIReady();
  }
});

// Add this to help with debugging
window.addEventListener('videoStateChange', function(event) {
  console.log('Video state changed:', event.detail.state);
});

document.addEventListener('DOMContentLoaded', function() {
    if (typeof YT !== 'undefined' && typeof YT.Player !== 'undefined') {
        onYouTubeIframeAPIReady();
    }

    const slider = document.querySelector('.slider');
    const prevButton = document.querySelector('.prev');
    const nextButton = document.querySelector('.next');
    let currentIndex = 0;

    function updateSlider() {
        slider.style.transform = `translateX(-${currentIndex * 100}%)`;
    }

    prevButton.addEventListener('click', () => {
        if (currentIndex > 0) {
            currentIndex--;
            updateSlider();
        }
    });

    nextButton.addEventListener('click', () => {
        if (currentIndex < videoContainers.length - 1) {
            currentIndex++;
            updateSlider();
        }
    });
});
</script>
{% endblock %}